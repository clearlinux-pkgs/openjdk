From e1f9c9941775ced01eec58b793f2a69b5e5cf7f3 Mon Sep 17 00:00:00 2001
From: Mark D Horn <mark.d.horn@intel.com>
Date: Thu, 22 Oct 2020 16:04:00 -0700
Subject: [PATCH] Honor max_memory_to_use/JPEGMEM/-maxmemory

Fixes CVE-2020-14152

Inspired by:
https://github.com/libjpeg-turbo/libjpeg-turbo/commit/da2a27ef056a0179cbd80f9146e58b89403d9933

Signed-off-by: Mark D Horn <mark.d.horn@intel.com>
---
 jdk/src/share/native/sun/awt/image/jpeg/jmemnobs.c | 14 +++++++++-----
 1 file changed, 9 insertions(+), 5 deletions(-)

diff --git a/jdk/src/share/native/sun/awt/image/jpeg/jmemnobs.c b/jdk/src/share/native/sun/awt/image/jpeg/jmemnobs.c
index ac455985aa2c..f4dd7decefb2 100644
--- a/jdk/src/share/native/sun/awt/image/jpeg/jmemnobs.c
+++ b/jdk/src/share/native/sun/awt/image/jpeg/jmemnobs.c
@@ -76,11 +76,15 @@ GLOBAL(size_t)
 jpeg_mem_available (j_common_ptr cinfo, size_t min_bytes_needed,
                     size_t max_bytes_needed, size_t already_allocated)
 {
-  if (cinfo->mem->max_memory_to_use)
-    return cinfo->mem->max_memory_to_use - already_allocated;
-
-  /* Here we say, "we got all you want bud!" */
-  return max_bytes_needed;
+  if (cinfo->mem->max_memory_to_use) {
+    if (cinfo->mem->max_memory_to_use > already_allocated)
+      return cinfo->mem->max_memory_to_use - already_allocated;
+    else
+      return 0;
+  } else {
+    /* Here we always say, "we got all you want bud!" */
+    return max_bytes_needed;
+  }
 }
 
 
-- 
2.29.0

